<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å®¹é ç´„ç³»çµ± (æ—¥ç¨‹è¡¨ç‰ˆ)</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Font Awesome åœ–ç¤º -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- è¼‰å…¥ flatpickr (æ—¥æœŸé¸æ“‡å™¨) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/zh-tw.js"></script>
    <!-- SweetAlert2 (æ›´æ¼‚äº®çš„æç¤ºæ¡†) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* è¡¨æ ¼æ¨£å¼å„ªåŒ– */
        .schedule-table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .schedule-table th {
            background-color: #f9fafb;
            color: #374151;
            font-weight: 600;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .schedule-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: middle;
            height: 60px; /* å›ºå®šæœ€å°é«˜åº¦ï¼Œæ–¹ä¾¿é»æ“Š */
        }
        .schedule-table tr:hover td {
            background-color: #f8fafc;
        }
        /* æ™‚é–“æ¬„ä½ */
        .time-cell {
            width: 100px;
            font-weight: bold;
            color: #4b5563;
            background-color: #f9fafb;
            border-right: 1px solid #e5e7eb;
            text-align: center;
        }
        /* å…§å®¹æ¬„ä½ - å¯é»æ“Šå€åŸŸ */
        .content-cell {
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s;
        }
        .content-cell:hover {
            background-color: #eff6ff; /* æ·ºè—è‰² hover */
        }
        
        /* é ç´„ç¾¤çµ„æ¨£å¼ */
        .appt-group {
            border-left: 4px solid #cbd5e1;
            padding-left: 8px;
            margin-bottom: 12px;
        }
        .appt-group:last-child {
            margin-bottom: 0;
        }

        /* é ç´„å¡ç‰‡ */
        .appt-chip {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 6px 10px;
            border-radius: 12px;
            font-size: 0.9rem;
            margin-right: 0;
            margin-bottom: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: transform 0.1s;
            width: fit-content; 
            max-width: 100%;
            white-space: normal;
        }
        .appt-group .appt-chip:last-child {
            margin-bottom: 0;
        }
        .appt-chip:hover {
            transform: scale(1.01);
            filter: brightness(0.95);
        }
        .bg-beauty { background-color: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        .bg-bath { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .bg-single { background-color: #fef9c3; color: #854d0e; border: 1px solid #fde047; }
        
        /* Modal å‹•ç•« */
        .modal {
            transition: opacity 0.25s ease;
        }
        body.modal-active {
            overflow: hidden;
        }

        /* è®€å–é®ç½© */
        .loader-overlay {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(2px);
        }

        /* æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
        @media (max-width: 640px) {
            .time-cell { width: 70px; font-size: 0.9rem; }
            .content-cell { font-size: 0.9rem; }
            .hidden-mobile { display: none; }
        }
        
        /* æ»¾å‹•æ¢ç¾åŒ– */
        #profile-list-container::-webkit-scrollbar { width: 6px; }
        #profile-list-container::-webkit-scrollbar-track { background: #f1f1f1; }
        #profile-list-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        #profile-list-container::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* å…¬ä¼‘è¨­å®šæ—¥æ›†æ¨£å¼ï¼šåç° */
        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange, .flatpickr-day.selected.inRange {
            background: #9ca3af !important; border-color: #9ca3af !important; color: #fff;
        }
        
        /* ç‡Ÿæ¥­æ—¥æŒ‰éˆ•æ»¾å‹•æ¢ */
        #business-days-container::-webkit-scrollbar { height: 4px; }
        #business-days-container::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 4px; }
        
        /* ç¾å®¹å·²æ»¿æŒ‰éˆ•æ¨£å¼ */
        .btn-full-active {
            background-color: #ef4444 !important; color: white !important; border-color: #dc2626 !important;
        }
        
        /* ç•¶æ—¥å·²æ»¿æ™‚ï¼Œè¡¨æ ¼èƒŒæ™¯å¾®èª¿ */
        .schedule-full-bg {
            background-color: #fef2f2;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- é ‚éƒ¨å°èˆªåˆ— -->
    <header class="bg-white shadow-sm z-20 sticky top-0">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            
            <!-- å·¦å´å€å¡Šï¼šLogo + æ¨™é¡Œ + æ”¯æŒå€å¡Š -->
            <div class="flex items-center gap-6">
                <!-- Logo & Title -->
                <div class="flex items-center gap-3">
                    <img src="icon.ico" alt="Logo" class="w-12 h-12 rounded-lg object-contain">
                    <div>
                        <h1 class="text-lg font-bold leading-tight">ç¾å®¹é ç´„è¡¨</h1>
                        <div class="text-xs text-gray-500" id="current-store-name">è®€å–ä¸­...</div>
                    </div>
                </div>

                <!-- [æ–°å¢] æ”¯æŒå€å¡Š (é ­åƒ+IGé€£çµ) -->
                <div class="hidden md:flex items-center gap-3 px-3 py-1.5 bg-gray-50 rounded-full border border-gray-100">
                    <!-- 4å¼µé ­åƒ (åœ“å½¢é‡ç–Š) -->
                    <div class="flex -space-x-2">
                        <img src="4.ico" class="inline-block h-8 w-8 rounded-full ring-2 ring-white object-cover" alt="Support 4">
                        <img src="3.ico" class="inline-block h-8 w-8 rounded-full ring-2 ring-white object-cover" alt="Support 3">
                        <img src="2.ico" class="inline-block h-8 w-8 rounded-full ring-2 ring-white object-cover" alt="Support 2">
                        <img src="1.ico" class="inline-block h-8 w-8 rounded-full ring-2 ring-white object-cover" alt="Support 1">
                    </div>
                    
                    <!-- æ–‡å­—èˆ‡ IG åœ–ç¤º -->
                    <a href="https://www.instagram.com/tsikkong/?igsh=MTdqYmV6YmNoeGhpZg%3D%3D&utm_source=qr" target="_blank" class="flex items-center gap-1.5 text-sm text-blue-600 font-medium hover:text-blue-800 hover:underline transition">
                        <i class="fa-brands fa-instagram text-lg"></i>
                        <span>æ²’æœ‰è¦æ–—å…§ï¼Œä½†å¯ä»¥é»é€²ä¾†æ”¯æŒä¸€ä¸‹</span>
                    </a>
                </div>
            </div>
            
            <!-- å³å´å€å¡Šï¼šæ§åˆ¶é … -->
            <div class="flex items-center gap-2">
                <select id="store-select" class="form-select text-sm border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                    <option value="">è¼‰å…¥åˆ†åº—...</option>
                </select>
                <button id="lock-store-btn" class="text-gray-400 hover:text-blue-600 transition" title="é–å®šåˆ†åº—">
                    <i class="fa-solid fa-lock-open" id="lock-icon"></i>
                </button>
                <button onclick="toggleSidebar()" class="ml-2 p-2 text-gray-600 hover:bg-gray-100 rounded-full lg:hidden">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
            </div>
        </div>
        
        <!-- æ—¥æœŸå°èˆªèˆ‡å…¬ä¼‘è¨­å®šåˆ— -->
        <div class="bg-gray-50 border-t border-gray-200 px-4 py-2 flex items-center gap-4 overflow-hidden">
            <!-- å·¦å´ï¼šå¿«é€Ÿè·³è½‰ -->
            <div class="flex-shrink-0 relative group">
                <label class="block text-xs text-gray-400 font-bold mb-0.5 ml-1">å¿«é€Ÿè·³è½‰</label>
                <div class="flex items-center bg-white border border-gray-300 rounded-md shadow-sm hover:border-blue-400 transition cursor-pointer">
                    <i class="fa-regular fa-calendar text-gray-500 pl-3"></i>
                    <input type="text" id="nav-date-picker" class="w-28 text-center font-bold text-gray-700 border-none focus:ring-0 cursor-pointer py-1.5 text-sm" readonly placeholder="é¸æ“‡æ—¥æœŸ">
                </div>
            </div>

            <!-- å³å´ï¼šç‡Ÿæ¥­æ—¥æŒ‰éˆ•åˆ— -->
            <div class="flex-1 flex items-center gap-2 overflow-x-auto pb-1" id="business-days-container">
                <div class="text-sm text-gray-400">è¼‰å…¥ç‡Ÿæ¥­æ—¥...</div>
            </div>
        </div>
        <!-- çµ±è¨ˆæ•¸æ“š -->
        <div class="bg-white border-t border-gray-100 px-4 py-1 flex justify-end items-center gap-3 text-xs font-medium text-gray-600">
             <span class="px-2 py-0.5 bg-gray-50 text-gray-700 rounded-full border border-gray-200">ç¸½ç­†æ•¸: <span id="stat-total">0</span></span>
             <span class="px-2 py-0.5 bg-blue-50 text-blue-700 rounded-full border border-blue-100">ç¾å®¹: <span id="stat-beauty">0</span></span>
             <span class="px-2 py-0.5 bg-green-50 text-green-700 rounded-full border border-green-100">æ´—æ¾¡: <span id="stat-bath">0</span></span>
             <span class="px-2 py-0.5 bg-yellow-50 text-yellow-700 rounded-full border border-yellow-100">å–®é …: <span id="stat-single">0</span></span>
        </div>
    </header>

    <!-- ä¸»å…§å®¹å€ -->
    <main class="flex-1 overflow-hidden flex relative">
        
        <!-- å·¦å´ï¼šæ—¥ç¨‹è¡¨ -->
        <div class="flex-1 overflow-y-auto p-2 md:p-4 relative" id="schedule-container">
            
            <!-- é ç´„è¡¨æ ¼ä¸Šæ–¹çš„åŠŸèƒ½åˆ— -->
            <div class="mb-4 px-1">
                <div class="flex items-center justify-between mb-2">
                    <label class="inline-flex items-center cursor-pointer bg-white border border-red-200 px-3 py-1.5 rounded-full hover:bg-red-50 transition shadow-sm">
                        <input type="checkbox" id="is-full-checkbox" class="form-checkbox h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                        <span class="ml-2 text-sm font-bold text-red-600">ç¾å®¹å·²æ»¿ (ç¦æ­¢æ–°å¢)</span>
                    </label>
                    <div class="text-xs text-gray-400">é ç´„å…§å®¹ (é»æ“Šç©ºç™½è™•æ–°å¢)</div>
                </div>
                
                <!-- ç•¶æ—¥å‚™è¨»å€å¡Š -->
                <div class="bg-white border border-gray-200 rounded-lg p-2 shadow-sm">
                    <div class="flex items-center gap-2 mb-1">
                        <i class="fa-regular fa-calendar-check text-blue-500"></i>
                        <label class="text-sm font-bold text-gray-700">ç•¶æ—¥å‚™è¨»</label>
                    </div>
                    <textarea id="daily-note" rows="2" class="w-full p-2 border border-gray-200 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition resize-none" placeholder="ä¾‹å¦‚ï¼šä»Šæ—¥äººæ‰‹ä¸è¶³... (è‡ªå‹•å„²å­˜)"></textarea>
                </div>
            </div>

            <!-- è®€å–é®ç½© -->
            <div id="loader" class="loader-overlay absolute inset-0 z-30 flex flex-col items-center justify-center hidden">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-3"></div>
                <p class="text-gray-600 font-medium" id="loader-text">è³‡æ–™åŒæ­¥ä¸­...</p>
            </div>

            <!-- å…¬ä¼‘æç¤º -->
            <div id="day-off-banner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 rounded shadow-sm" role="alert">
                <p class="font-bold"><i class="fa-solid fa-mug-hot mr-2"></i>æœ¬æ—¥å…¬ä¼‘</p>
                <p>å¦‚éœ€é ç´„è«‹é¸æ“‡å…¶ä»–æ—¥æœŸã€‚</p>
            </div>

            <!-- æ—¥ç¨‹è¡¨æ ¼ -->
            <table class="schedule-table">
                <thead>
                    <tr>
                        <th class="w-20 text-center">æ™‚é–“</th>
                        <th></th> 
                    </tr>
                </thead>
                <tbody id="schedule-body">
                    <!-- JS å‹•æ…‹ç”Ÿæˆ -->
                </tbody>
            </table>
            
            <div class="h-20"></div>
        </div>

        <!-- å³å´æ»‘å‹•å´é‚Šæ¬„ -->
        <div id="sidebar" class="absolute inset-y-0 right-0 w-96 bg-white shadow-xl border-l border-gray-200 transform translate-x-full transition-transform duration-300 ease-in-out z-40 flex flex-col lg:static lg:translate-x-0">
            <div class="p-3 bg-gray-50 border-b flex justify-between items-center">
                <h3 class="font-bold text-lg text-gray-700"><i class="fa-solid fa-sliders mr-2"></i>åŠŸèƒ½é¢æ¿</h3>
                <button onclick="toggleSidebar()" class="text-gray-500 hover:text-gray-700 lg:hidden">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-hidden flex flex-col">
                <!-- ç‰¹åˆ¥æ³¨æ„äº‹é …å€å¡Š -->
                <div class="flex-1 flex flex-col min-h-0 bg-gray-50">
                    <div class="p-3 bg-white border-b border-gray-200">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-gray-700">
                                <i class="fa-solid fa-book-medical mr-1"></i>ç‰¹åˆ¥æ³¨æ„äº‹é …
                            </h4>
                            <button onclick="openProfileModal()" class="text-sm bg-blue-600 text-white px-3 py-1.5 rounded-md hover:bg-blue-700 transition shadow-sm flex items-center">
                                <i class="fa-solid fa-plus mr-1"></i>æ–°å¢
                            </button>
                        </div>
                        <div class="relative">
                            <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
                            <input type="text" id="profile-search" oninput="filterProfileList()" placeholder="æœå°‹å“ç¨®æˆ–åå­—..." class="w-full pl-9 pr-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div id="profile-list-container" class="flex-1 overflow-y-auto p-2 space-y-2">
                        <div class="text-center text-gray-400 text-sm py-4">è®€å–ä¸­...</div>
                    </div>
                </div>

                <!-- å…¬ä¼‘è¨­å®šå€å¡Š -->
                <div class="p-3 bg-white border-t border-gray-100">
                    <label class="block text-sm font-bold text-gray-700 mb-1">
                        <i class="fa-regular fa-calendar-xmark mr-1"></i>å…¬ä¼‘è¨­å®š
                    </label>
                    <div class="flex items-center bg-gray-50 border border-gray-300 rounded-md shadow-sm hover:border-blue-400 transition cursor-pointer">
                         <input type="text" id="sidebar-dayoff-picker" class="w-full text-center font-medium text-gray-700 bg-transparent border-none focus:ring-0 cursor-pointer py-2 text-sm" readonly placeholder="é»æ“Šè¨­å®šå…¬ä¼‘">
                    </div>
                    <div class="text-xs text-gray-400 mt-1 text-center">é»é¸æ—¥æœŸä»¥åˆ‡æ›å…¬ä¼‘ç‹€æ…‹</div>
                </div>
            </div>
        </div>
        
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden transition-opacity lg:hidden"></div>
    </main>

    <!-- æ‡¸æµ®æ–°å¢æŒ‰éˆ• -->
    <button onclick="openAppointmentModal()" class="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-blue-700 transition md:hidden z-20">
        <i class="fa-solid fa-plus text-xl"></i>
    </button>

    <!-- Modals -->
    <div id="appointment-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true"><div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"><div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeAppointmentModal()"></div><span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span><div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full"><div class="bg-gray-50 px-4 py-3 border-b flex justify-between items-center"><h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title"><i class="fa-regular fa-calendar-plus mr-2"></i><span id="appt-modal-title">æ–°å¢é ç´„</span></h3><button onclick="closeAppointmentModal()" class="text-gray-400 hover:text-gray-500"><i class="fa-solid fa-xmark text-xl"></i></button></div><div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4 max-h-[70vh] overflow-y-auto"><form id="appointment-form" class="space-y-4"><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700">æ—¥æœŸ</label><input type="text" id="appt-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100 cursor-not-allowed" readonly></div><div><label class="block text-sm font-medium text-gray-700">æ™‚é–“</label><select id="appt-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200"></select></div></div><div class="grid grid-cols-3 gap-4"><div class="col-span-2"><label class="block text-sm font-medium text-gray-700">é›»è©±è™Ÿç¢¼</label><input type="tel" id="appt-phone" placeholder="0912345678" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 p-2 border"></div><div class="flex items-center pt-6"><label class="inline-flex items-center"><input type="checkbox" id="appt-is-app" class="form-checkbox h-5 w-5 text-blue-600 rounded"><span class="ml-2 text-gray-700 text-sm">APPé ç´„</span></label></div></div><hr class="border-gray-200"><div id="pets-container" class="space-y-4"></div><button type="button" onclick="addPetField()" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-500 hover:text-blue-500 text-sm font-medium transition"><i class="fa-solid fa-plus mr-1"></i> æ–°å¢ç¬¬äºŒéš»å¯µç‰©</button><input type="hidden" id="delete-row-ids"></form></div><div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse gap-2"><button type="button" onclick="submitAppointment()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">å„²å­˜é ç´„</button><button type="button" id="btn-delete-appt" onclick="deleteCurrentAppointment()" class="hidden w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">åˆªé™¤æ­¤é ç´„</button><button type="button" onclick="closeAppointmentModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">å–æ¶ˆ</button></div></div></div></div>
    <div id="profile-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"><div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold" id="profile-modal-title">æ–°å¢æ³¨æ„äº‹é …</h3><button onclick="document.getElementById('profile-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700"><i class="fa-solid fa-xmark text-xl"></i></button></div><div class="bg-gray-50 p-4 rounded mb-4"><form id="profile-form" class="space-y-3"><input type="hidden" name="id" id="profile-id"><div class="grid grid-cols-2 gap-3"><div><label class="block text-sm font-medium text-gray-700 mb-1">å“ç¨®</label><input type="text" name="breed" id="profile-breed" placeholder="å¦‚:è²´è³“" class="w-full border p-2 rounded text-sm focus:ring-blue-500 focus:border-blue-500"></div><div><label class="block text-sm font-medium text-gray-700 mb-1">å¯µç‰©å</label><input type="text" name="name" id="profile-name" placeholder="å¦‚:å¯¶å¯¶" class="w-full border p-2 rounded text-sm focus:ring-blue-500 focus:border-blue-500"></div></div><div><label class="block text-sm font-medium text-gray-700 mb-1">æ³¨æ„äº‹é …å…§å®¹</label><textarea name="notes" id="profile-notes" placeholder="ä¾‹å¦‚ï¼šæœƒå’¬äººã€æ€•å¹é¢¨æ©Ÿ..." class="w-full border p-2 rounded text-sm focus:ring-blue-500 focus:border-blue-500" rows="3"></textarea></div><div class="flex gap-2 pt-2"><button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition font-medium">å„²å­˜</button><button type="button" onclick="document.getElementById('profile-modal').classList.add('hidden')" class="px-4 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition">å–æ¶ˆ</button></div></form></div></div></div>

    <!-- JS é‚è¼¯ -->
    <script>
        // è¨­å®šå€
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxZ8Z16SBwAxn0AeycM6VxRLrOyO8Hy9vJ2U4PQkEq8n8GNFZFViYneIT8yQTo5hitX7A/exec';
        
        // å®£å‘Šå…¨åŸŸè®Šæ•¸ (é¿å… ReferenceError)
        let allStores = [];
        let currentStoreId = null;
        let currentDate = new Date();
        let currentViewMonthDate = new Date();
        let currentAppointments = [];
        let currentDaysOff = [];
        let allPetProfiles = [];
        let storeConfig = { start: "09:00", end: "21:00", unit: 60 };
        let isCurrentDateFull = false;
        let scheduleCache = {};

        // DOM å…ƒç´ è®Šæ•¸å®£å‘Š
        let storeSelect, navDatePickerInput, businessDaysContainer, scheduleBody, loader, loaderText, lockBtn, lockIcon, modal, dailyNoteInput, isFullCheckbox;

        document.addEventListener('DOMContentLoaded', async () => {
            // åˆå§‹åŒ– DOM è®Šæ•¸
            storeSelect = document.getElementById('store-select');
            navDatePickerInput = document.getElementById('nav-date-picker');
            businessDaysContainer = document.getElementById('business-days-container');
            scheduleBody = document.getElementById('schedule-body');
            loader = document.getElementById('loader');
            loaderText = document.getElementById('loader-text');
            lockBtn = document.getElementById('lock-store-btn');
            lockIcon = document.getElementById('lock-icon');
            modal = document.getElementById('appointment-modal'); // [é‡è¦] ç¢ºä¿ modal è¢«æ­£ç¢ºæŠ“å–
            dailyNoteInput = document.getElementById('daily-note');
            isFullCheckbox = document.getElementById('is-full-checkbox');

            initDatePickers();
            try {
                await fetchStoreData();
            } catch (e) {
                console.error('Init Error:', e);
                Swal.fire('ç³»çµ±éŒ¯èª¤', 'ç„¡æ³•è¼‰å…¥åˆå§‹è³‡æ–™ï¼Œè«‹é‡æ–°æ•´ç†ç¶²é ', 'error');
            } finally {
                toggleLoader(false); 
            }
            
            storeSelect.addEventListener('change', handleStoreChange);
            lockBtn.addEventListener('click', toggleStoreLock);
            dailyNoteInput.addEventListener('change', saveDailyNote);
            isFullCheckbox.addEventListener('change', handleIsFullChange);
            document.getElementById('appointment-form').addEventListener('submit', (e) => e.preventDefault());
            document.getElementById('profile-form').addEventListener('submit', handleProfileSubmit);
        });

        async function apiCall(action, params = {}, method = 'GET') {
            if (action !== 'getStoreData' && currentStoreId) params.storeId = currentStoreId;
            let url = WEB_APP_URL;
            const options = { method, mode: 'cors' };
            if (method === 'GET') {
                const query = new URLSearchParams({ action, ...params, t: new Date().getTime() });
                url += `?${query}`;
            } else {
                options.body = JSON.stringify({ action, ...params });
                options.headers = { 'Content-Type': 'text/plain;charset=utf-8' };
            }
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000);
            options.signal = controller.signal;

            try {
                const res = await fetch(url, options);
                clearTimeout(timeoutId);
                if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
                const json = await res.json();
                if (json.status !== 'success') throw new Error(json.message || 'API å›å‚³å¤±æ•—');
                return json.data;
            } catch (err) {
                clearTimeout(timeoutId);
                if (err.name === 'AbortError') throw new Error('é€£ç·šé€¾æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦');
                throw err;
            }
        }

        async function fetchStoreData() {
            toggleLoader(true, 'è®€å–åˆ†åº—è³‡æ–™...');
            try {
                allStores = await apiCall('getStoreData');
                if (!allStores || allStores.length === 0) throw new Error('æ‰¾ä¸åˆ°åˆ†åº—è³‡æ–™');

                storeSelect.innerHTML = '<option value="">è«‹é¸æ“‡åˆ†åº—</option>';
                allStores.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id; opt.text = s.name; storeSelect.appendChild(opt);
                });

                const lockedId = localStorage.getItem('petStore_lockedId');
                let targetStoreId = null;
                if (lockedId && allStores.find(s => s.id === lockedId)) {
                    targetStoreId = lockedId; toggleStoreLock(true);
                } else if(allStores.find(s => s.id === 'S5100')) {
                    targetStoreId = 'S5100';
                }
                
                if (targetStoreId) {
                    storeSelect.value = targetStoreId;
                    await handleStoreChange();
                } else {
                    toggleLoader(false);
                }
            } catch (e) {
                console.error(e);
                Swal.fire('è¼‰å…¥å¤±æ•—', e.message, 'error');
            }
        }

        async function handleStoreChange() {
            currentStoreId = storeSelect.value;
            if (!currentStoreId) { toggleLoader(false); return; }

            const store = allStores.find(s => s.id === currentStoreId);
            if (store) {
                storeConfig = { start: store.startTime || "09:00", end: store.endTime || "21:00", unit: parseInt(store.timeUnit) || 60 };
                document.getElementById('current-store-name').innerText = store.name;
            }
            
            scheduleCache = {}; 
            generateTimeSlotsOption();
            
            toggleLoader(true, 'è¼‰å…¥åº—é‹ªè³‡æ–™...');
            try {
                await Promise.all([ fetchDaysOff(), fetchPetProfiles(), loadSchedule(false) ]);
            } catch(e) {
                console.error("Store Change Error", e);
                Swal.fire('éŒ¯èª¤', 'åˆ‡æ›åˆ†åº—æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            } finally {
                toggleLoader(false);
            }
        }

        function toggleStoreLock(forceState) {
            let isLocked;
            if (typeof forceState === 'boolean') isLocked = forceState;
            else isLocked = !storeSelect.disabled;
            storeSelect.disabled = isLocked;
            if (isLocked) {
                lockIcon.className = 'fa-solid fa-lock';
                if(storeSelect.value) localStorage.setItem('petStore_lockedId', storeSelect.value);
            } else {
                lockIcon.className = 'fa-solid fa-lock-open';
                localStorage.removeItem('petStore_lockedId');
            }
        }

        async function loadSchedule(handleLoading = true) {
            if (!currentStoreId) return;
            const dateStr = formatDate(currentDate);
            document.getElementById('day-off-banner').classList.add('hidden');
            renderBusinessDayButtons(); 

            if (scheduleCache[dateStr]) {
                const cached = scheduleCache[dateStr];
                currentAppointments = cached.appts;
                processDailyNote(cached.note || ''); 
                checkDayOffAndRender(dateStr);
                renderBusinessDayButtons(); 
                if(handleLoading) toggleLoader(false);
                return; 
            }

            if(handleLoading) toggleLoader(true, 'åŒæ­¥é ç´„è³‡æ–™...');
            try {
                const [appts, note] = await Promise.all([
                    apiCall('getAppointments', { date: dateStr }),
                    apiCall('getDailyNote', { date: dateStr })
                ]);
                currentAppointments = groupAppointments(appts);
                processDailyNote(note || '');
                scheduleCache[dateStr] = { appts: currentAppointments, note: note || '' };
                checkDayOffAndRender(dateStr);
                renderBusinessDayButtons();
            } catch (e) {
                console.error(e);
                if(handleLoading) Swal.fire('è®€å–å¤±æ•—', 'ç„¡æ³•å–å¾—é ç´„è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            } finally {
                if(handleLoading) toggleLoader(false);
            }
        }
        
        function processDailyNote(note) {
            if (note.startsWith('[FULL]')) {
                isCurrentDateFull = true; isFullCheckbox.checked = true; dailyNoteInput.value = note.substring(6);
            } else {
                isCurrentDateFull = false; isFullCheckbox.checked = false; dailyNoteInput.value = note;
            }
        }
        
        function checkDayOffAndRender(dateStr) {
            const isDayOff = currentDaysOff.includes(dateStr);
            if (isDayOff) document.getElementById('day-off-banner').classList.remove('hidden');
            renderTable();
            updateStats();
        }

        function renderTable() {
            scheduleBody.innerHTML = '';
            const times = generateTimeSlots();
            if (isCurrentDateFull) document.getElementById('schedule-container').classList.add('schedule-full-bg');
            else document.getElementById('schedule-container').classList.remove('schedule-full-bg');
            
            times.forEach(time => {
                const tr = document.createElement('tr');
                const tdTime = document.createElement('td');
                tdTime.className = 'time-cell'; tdTime.textContent = time; tr.appendChild(tdTime);
                const tdContent = document.createElement('td');
                tdContent.className = 'content-cell';
                
                const appointments = currentAppointments.filter(app => app.time === time);
                if (appointments.length > 0) {
                    appointments.forEach(app => {
                        const groupDiv = document.createElement('div');
                        groupDiv.className = 'appt-group';
                        app.pets.forEach(pet => {
                            const chip = document.createElement('div');
                            const serviceClass = getServiceColorClass(pet.service);
                            chip.className = `appt-chip ${serviceClass}`;
                            const line1 = [pet.species, pet.breed, pet.name, pet.service].filter(v => v && v !== 'æœªå¡«').join(' ');
                            let phoneDisplay = app.phone || '';
                            if (phoneDisplay.length === 9 && phoneDisplay.startsWith('9')) phoneDisplay = '0' + phoneDisplay;
                            const line2 = [phoneDisplay, pet.note].filter(v => v && v !== 'æœªå¡«').join(' ');
                            const appBadge = app.isApp ? '<i class="fa-solid fa-mobile-screen ml-1 text-xs"></i>' : '';
                            chip.innerHTML = `<div class="font-bold text-sm w-full flex justify-between"><span>${line1 || 'ç„¡è³‡æ–™'}</span><span>${appBadge}</span></div><div class="text-xs opacity-90 mt-1 break-all">${line2}</div>`;
                            chip.onclick = (e) => { e.stopPropagation(); openAppointmentModal(app); };
                            groupDiv.appendChild(chip);
                        });
                        tdContent.appendChild(groupDiv);
                    });
                    tdContent.onclick = (e) => {
                        if (isCurrentDateFull) { Swal.fire('ç„¡æ³•æ–°å¢', 'æœ¬æ—¥ç¾å®¹é ç´„å·²æ»¿', 'warning'); return; }
                        if(e.target === tdContent || e.target.classList.contains('appt-group')) openAppointmentModal(null, time);
                    };
                } else {
                    tdContent.onclick = () => {
                        if (isCurrentDateFull) { Swal.fire('ç„¡æ³•æ–°å¢', 'æœ¬æ—¥ç¾å®¹é ç´„å·²æ»¿', 'warning'); return; }
                        openAppointmentModal(null, time);
                    };
                    if (!isCurrentDateFull) tdContent.innerHTML = `<span class="text-gray-300 text-sm hidden-mobile hover:text-gray-400"><i class="fa-solid fa-plus"></i> é»æ“Šç©ºç™½è™•æ–°å¢</span>`;
                }
                tr.appendChild(tdContent); scheduleBody.appendChild(tr);
            });
        }

        function groupAppointments(rawData) {
            const groups = {};
            rawData.forEach((item, idx) => {
                const time = formatTime(item['æ™‚é–“']);
                const phone = item['é€£çµ¡é›»è©±'];
                const key = phone ? `${time}_${phone}` : `${time}_raw_${idx}`;
                if (!groups[key]) groups[key] = { key: key, time: time, phone: phone, isApp: item['APPé ç´„'] === 'Y', pets: [], services: [], notes: [], rowIDs: [] };
                groups[key].pets.push({ breed: item['å“ç¨®'], name: item['å¯µç‰©å'], species: item['ç¨®é¡'], service: item['æœå‹™å…§å®¹'], note: item['å‚™è¨»'] });
                groups[key].services.push(item['æœå‹™å…§å®¹']); groups[key].notes.push(item['å‚™è¨»']); groups[key].rowIDs.push(item.rowID);
            });
            return Object.values(groups);
        }
        
        function openAppointmentModal(existingAppt = null, timeSlot = '') {
            const modalTitle = document.getElementById('appt-modal-title');
            const dateField = document.getElementById('appt-date');
            const timeField = document.getElementById('appt-time');
            const phoneField = document.getElementById('appt-phone');
            const isAppField = document.getElementById('appt-is-app');
            const deleteBtn = document.getElementById('btn-delete-appt');
            const deleteIdsField = document.getElementById('delete-row-ids');
            const petsContainer = document.getElementById('pets-container');
            
            // [å®‰å…¨ä¿®æ­£] æª¢æŸ¥ modal æ˜¯å¦å­˜åœ¨
            if (!modal) modal = document.getElementById('appointment-modal');

            dateField.value = formatDate(currentDate);
            phoneField.value = '';
            isAppField.checked = false;
            deleteIdsField.value = '';
            petsContainer.innerHTML = '';
            
            if (existingAppt) {
                modalTitle.innerText = "ç·¨è¼¯/æª¢è¦–é ç´„";
                timeField.value = existingAppt.time;
                phoneField.value = existingAppt.phone;
                isAppField.checked = existingAppt.isApp;
                deleteBtn.classList.remove('hidden');
                deleteIdsField.value = JSON.stringify(existingAppt.rowIDs);
                existingAppt.pets.forEach((pet) => { addPetField(pet); });
            } else {
                modalTitle.innerText = "æ–°å¢é ç´„";
                timeField.value = timeSlot || generateTimeSlots()[0];
                deleteBtn.classList.add('hidden');
                addPetField();
            }
            modal.classList.remove('hidden');
        }

        function closeAppointmentModal() {
            if (!modal) modal = document.getElementById('appointment-modal');
            modal.classList.add('hidden');
        }
        
        function addPetField(data = null) {
            const container = document.getElementById('pets-container');
            const index = container.children.length + 1;
            const div = document.createElement('div');
            div.className = 'pet-entry bg-gray-50 p-3 rounded-lg border border-gray-200 relative mt-2';
            div.innerHTML = `
                <div class="flex justify-between mb-2">
                    <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wide">å¯µç‰© ${index}</h4>
                    ${index > 1 ? '<button type="button" onclick="this.parentElement.parentElement.remove()" class="text-red-500 text-xs hover:text-red-700">ç§»é™¤</button>' : ''}
                </div>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <select class="pet-species w-full rounded border-gray-300 text-sm p-1.5 border"><option value="ç‹—">ğŸ¶ ç‹—</option><option value="è²“">ğŸ± è²“</option><option value="å…”å­">ğŸ° å…”å­</option></select>
                    <select class="pet-service w-full rounded border-gray-300 text-sm p-1.5 border"><option value="ç¾å®¹">âœ‚ï¸ ç¾å®¹</option><option value="æ´—æ¾¡">ğŸš¿ æ´—æ¾¡</option><option value="å–®é …">ğŸ’… å–®é …</option></select>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <input type="text" class="pet-breed w-full rounded border-gray-300 text-sm p-1.5 border" placeholder="å“ç¨®" oninput="checkPetNotes(this)">
                    <input type="text" class="pet-name w-full rounded border-gray-300 text-sm p-1.5 border" placeholder="å¯µç‰©å" oninput="checkPetNotes(this)">
                </div>
                <textarea class="pet-notes w-full rounded border-gray-300 text-sm p-1.5 border" rows="1" placeholder="å‚™è¨»..."></textarea>
                <div class="pet-auto-note hidden mt-2 p-2 bg-yellow-50 text-yellow-800 text-xs rounded border border-yellow-200"></div>
            `;
            container.appendChild(div);
            if (data) {
                div.querySelector('.pet-species').value = data.species || 'ç‹—';
                div.querySelector('.pet-service').value = data.service || 'ç¾å®¹';
                div.querySelector('.pet-breed').value = data.breed || '';
                div.querySelector('.pet-name').value = data.name || '';
                div.querySelector('.pet-notes').value = data.note || '';
                checkPetNotes(div.querySelector('.pet-breed'));
            }
        }

        async function submitAppointment() {
            const date = document.getElementById('appt-date').value;
            const time = document.getElementById('appt-time').value;
            const phone = document.getElementById('appt-phone').value;
            const isApp = document.getElementById('appt-is-app').checked;
            const deleteRowIds = document.getElementById('delete-row-ids').value;
            const pets = [];
            document.querySelectorAll('.pet-entry').forEach(div => {
                const breed = div.querySelector('.pet-breed').value.trim();
                const name = div.querySelector('.pet-name').value.trim();
                const service = div.querySelector('.pet-service').value;
                if (breed || name || service) {
                    pets.push({
                        species: div.querySelector('.pet-species').value,
                        breed: breed, petName: name, service: service,
                        notes: div.querySelector('.pet-notes').value
                    });
                }
            });

            if (pets.length === 0) return Swal.fire('æç¤º', 'è«‹è‡³å°‘å¡«å¯«ä¸€éš»å¯µç‰©è³‡æ–™', 'warning');

            toggleLoader(true, 'å„²å­˜é ç´„ä¸­...');
            try {
                if (deleteRowIds) await apiCall('deleteAppointments', { rowIDs: JSON.parse(deleteRowIds) }, 'POST');
                await apiCall('addAppointment', { date, time, phone, isApp, pets }, 'POST');
                delete scheduleCache[date];
                closeAppointmentModal();
                Swal.fire({ title: 'æˆåŠŸ', text: 'é ç´„å·²å„²å­˜', icon: 'success', timer: 1500, showConfirmButton: false });
                await loadSchedule(false);
            } catch (e) {
                Swal.fire('éŒ¯èª¤', 'å„²å­˜å¤±æ•—ï¼š' + e.message, 'error');
            } finally {
                toggleLoader(false);
            }
        }

        async function deleteCurrentAppointment() {
            const ids = document.getElementById('delete-row-ids').value;
            const date = document.getElementById('appt-date').value;
            if (!ids) return;
            const result = await Swal.fire({
                title: 'ç¢ºå®šåˆªé™¤?', text: "åˆªé™¤å¾Œç„¡æ³•å¾©åŸ", icon: 'warning',
                showCancelButton: true, confirmButtonText: 'åˆªé™¤', cancelButtonText: 'å–æ¶ˆ'
            });
            if (result.isConfirmed) {
                toggleLoader(true, 'åˆªé™¤ä¸­...');
                try {
                    await apiCall('deleteAppointments', { rowIDs: JSON.parse(ids) }, 'POST');
                    delete scheduleCache[date];
                    closeAppointmentModal();
                    await loadSchedule(false);
                    Swal.fire('å·²åˆªé™¤', '', 'success');
                } catch(e) { 
                    Swal.fire('éŒ¯èª¤', 'åˆªé™¤å¤±æ•—ï¼š' + e.message, 'error');
                } finally { 
                    toggleLoader(false); 
                }
            }
        }

        async function fetchPetProfiles() {
            try {
                const profiles = await apiCall('getPetProfiles');
                allPetProfiles = profiles;
                renderProfileListSidebar();
            } catch(e) {}
        }
        
        function renderProfileListSidebar(filterText = '') {
            const listContainer = document.getElementById('profile-list-container');
            const searchVal = filterText.toLowerCase();
            const filtered = allPetProfiles.filter(p => (p.breed && p.breed.toLowerCase().includes(searchVal)) || (p.name && p.name.toLowerCase().includes(searchVal)));
            
            if(filtered.length === 0) {
                listContainer.innerHTML = '<div class="text-center text-gray-400 text-sm py-4">ç„¡ç›¸ç¬¦è³‡æ–™</div>';
                return;
            }

            listContainer.innerHTML = filtered.map(p => `
                <div class="p-2 bg-white border border-gray-100 rounded-md hover:shadow-sm transition group relative">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-sm font-bold text-gray-800">${p.breed} - ${p.name}</div>
                            <div class="text-xs text-gray-500 mt-1 leading-relaxed">${p.notes}</div>
                        </div>
                        <div class="opacity-0 group-hover:opacity-100 transition flex gap-1 bg-white pl-2">
                             <button onclick="editProfile('${p.id}')" class="text-blue-500 hover:text-blue-700 p-1" title="ç·¨è¼¯"><i class="fa-solid fa-pen"></i></button>
                             <button onclick="deleteProfile('${p.id}')" class="text-red-500 hover:text-red-700 p-1" title="åˆªé™¤"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function filterProfileList() {
            const text = document.getElementById('profile-search').value;
            renderProfileListSidebar(text);
        }
        function openProfileModal() {
            document.getElementById('profile-modal-title').innerText = "æ–°å¢æ³¨æ„äº‹é …";
            document.getElementById('profile-form').reset();
            document.getElementById('profile-id').value = '';
            document.getElementById('profile-modal').classList.remove('hidden');
        }
        function editProfile(id) {
            const p = allPetProfiles.find(x => x.id === id);
            if(!p) return;
            document.getElementById('profile-modal-title').innerText = "ç·¨è¼¯æ³¨æ„äº‹é …";
            document.getElementById('profile-id').value = p.id;
            document.getElementById('profile-breed').value = p.breed;
            document.getElementById('profile-name').value = p.name;
            document.getElementById('profile-notes').value = p.notes;
            document.getElementById('profile-modal').classList.remove('hidden');
        }
        async function handleProfileSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            const action = data.id ? 'updatePetProfile' : 'addPetProfile';
            if(!data.breed && !data.name) return Swal.fire('æç¤º', 'è«‹è‡³å°‘è¼¸å…¥å“ç¨®æˆ–å¯µç‰©å', 'warning');
            document.getElementById('profile-modal').classList.add('hidden');
            toggleLoader(true, 'å„²å­˜æ³¨æ„äº‹é …...');
            try {
                await apiCall(action, data, 'POST');
                await fetchPetProfiles();
                Swal.fire({ icon: 'success', title: 'å„²å­˜æˆåŠŸ', toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
            } catch(e) {
                Swal.fire('éŒ¯èª¤', 'å„²å­˜å¤±æ•—', 'error');
            } finally { toggleLoader(false); }
        }
        async function deleteProfile(id) {
             const res = await Swal.fire({
                 title: 'ç¢ºå®šåˆªé™¤?', icon: 'warning', showCancelButton: true, confirmButtonText: 'åˆªé™¤', cancelButtonText: 'å–æ¶ˆ', confirmButtonColor: '#d33',
             });
             if(res.isConfirmed) {
                 toggleLoader(true, 'åˆªé™¤ä¸­...');
                 try {
                     await apiCall('deletePetProfile', {id}, 'POST');
                     await fetchPetProfiles();
                     Swal.fire('å·²åˆªé™¤', '', 'success');
                 } catch(e) {
                     Swal.fire('éŒ¯èª¤', 'åˆªé™¤å¤±æ•—', 'error');
                 } finally { toggleLoader(false); }
             }
        }
        function checkPetNotes(inputElement) {
            const container = inputElement.closest('.pet-entry');
            const breed = container.querySelector('.pet-breed').value.trim().toLowerCase();
            const name = container.querySelector('.pet-name').value.trim().toLowerCase();
            const noteDisplay = container.querySelector('.pet-auto-note');
            if (!breed && !name) { noteDisplay.classList.add('hidden'); return; }
            const found = allPetProfiles.find(p => (p.breed || '').toLowerCase() === breed && (p.name || '').toLowerCase() === name);
            if (found) {
                noteDisplay.innerHTML = `<strong><i class="fa-solid fa-circle-exclamation"></i> æ³¨æ„ï¼š</strong> ${found.notes}`;
                noteDisplay.classList.remove('hidden');
            } else { noteDisplay.classList.add('hidden'); }
        }

        function updateStats() {
            const statBeauty = document.getElementById('stat-beauty');
            const statBath = document.getElementById('stat-bath');
            const statSingle = document.getElementById('stat-single');
            const statTotal = document.getElementById('stat-total'); 
            if (!statBeauty || !statBath || !statSingle || !statTotal) return; 

            let beauty = 0, bath = 0, single = 0, total = 0;
            currentAppointments.forEach(group => {
                group.services.forEach(s => { 
                    total++; 
                    if (s === 'ç¾å®¹') beauty++; else if (s === 'æ´—æ¾¡') bath++; else if (s === 'å–®é …') single++; 
                });
            });
            statBeauty.textContent = beauty; statBath.textContent = bath; statSingle.textContent = single; statTotal.textContent = total;
        }

        function toggleLoader(show, text = 'è³‡æ–™åŒæ­¥ä¸­...') {
            if(show) {
                if(loaderText) loaderText.textContent = text;
                loader.classList.remove('hidden');
            } else {
                loader.classList.add('hidden');
            }
        }
        
        function handleIsFullChange() {
            const isChecked = isFullCheckbox.checked;
            let currentNote = dailyNoteInput.value;
            if (currentNote.startsWith('[FULL]')) currentNote = currentNote.substring(6); 
            const newNote = isChecked ? `[FULL]${currentNote}` : currentNote;
            isCurrentDateFull = isChecked; dailyNoteInput.value = currentNote; 
            saveDailyNote(newNote); renderTable(); renderBusinessDayButtons();
        }
        async function saveDailyNote(noteContent) {
            const dateStr = formatDate(currentDate);
            let notesToSend = noteContent;
            if (typeof notesToSend !== 'string') {
                let rawNote = dailyNoteInput.value;
                notesToSend = isFullCheckbox.checked ? `[FULL]${rawNote}` : rawNote;
            }
            if(scheduleCache[dateStr]) scheduleCache[dateStr].note = notesToSend;
            try {
                await apiCall('saveDailyNote', { date: dateStr, notes: notesToSend }, 'POST');
                const toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
                toast.fire({ icon: 'success', title: 'ç‹€æ…‹å·²å„²å­˜' });
            } catch (e) { console.error(e); }
        }
        
        function generateTimeSlots() { const slots = []; const [startH, startM] = storeConfig.start.split(':').map(Number); const [endH, endM] = storeConfig.end.split(':').map(Number); let currH = startH, currM = startM; while (currH < endH || (currH === endH && currM <= endM)) { slots.push(`${String(currH).padStart(2,'0')}:${String(currM).padStart(2,'0')}`); currM += storeConfig.unit; if (currM >= 60) { currH += Math.floor(currM / 60); currM %= 60; } } return slots; }
        function generateTimeSlotsOption() { const select = document.getElementById('appt-time'); select.innerHTML = ''; generateTimeSlots().forEach(time => { const opt = document.createElement('option'); opt.value = time; opt.text = time; select.appendChild(opt); }); }
        function formatDate(date) { const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
        function formatTime(timeVal) { if (timeVal instanceof Date) return `${String(timeVal.getHours()).padStart(2,'0')}:${String(timeVal.getMinutes()).padStart(2,'0')}`; if (typeof timeVal === 'string' && timeVal.includes('T')) { const d = new Date(timeVal); return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; } if (typeof timeVal === 'string' && timeVal.length > 5) return timeVal.substring(0, 5); return timeVal; }
        function getServiceColorClass(serviceName) { if (serviceName === 'ç¾å®¹') return 'bg-beauty'; if (serviceName === 'æ´—æ¾¡') return 'bg-bath'; if (serviceName === 'å–®é …') return 'bg-single'; return 'bg-gray-100 border-gray-200'; }
        function toggleSidebar() { const sidebar = document.getElementById('sidebar'); const overlay = document.getElementById('sidebar-overlay'); if (sidebar.classList.contains('translate-x-full')) { sidebar.classList.remove('translate-x-full'); overlay.classList.remove('hidden'); } else { sidebar.classList.add('translate-x-full'); overlay.classList.add('hidden'); } }
        
        // è£œå……ç¼ºå°‘çš„å‡½å¼
        function initDatePickers() {
            // [å·¦ä¸Šè§’] å¿«é€Ÿè·³è½‰æ—¥æ›† (å–®é¸)
            flatpickr("#nav-date-picker", {
                locale: "zh_tw",
                dateFormat: "Y-m-d",
                defaultDate: "today",
                onChange: (dates, dateStr) => {
                    currentDate = dates[0];
                    if (currentDate.getMonth() !== currentViewMonthDate.getMonth()) {
                        currentViewMonthDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                        renderBusinessDayButtons();
                    }
                    loadSchedule();
                }
            });

            // [å´é‚Šæ¬„] å…¬ä¼‘è¨­å®šæ—¥æ›† (å¤šé¸)
            flatpickr("#sidebar-dayoff-picker", {
                locale: "zh_tw",
                mode: "multiple",
                dateFormat: "Y-m-d",
                conjunction: " :: ",
                defaultDate: [],
                onChange: function(selectedDates, dateStr, instance) {
                    handleDaysOffChange(selectedDates, instance);
                }
            });
        }

        async function fetchDaysOff() {
            if (!currentStoreId) return;
            try {
                const data = await apiCall('getDaysOff');
                currentDaysOff = data.map(d => formatDate(new Date(d))).filter(d => d);
                
                // æ›´æ–°å´é‚Šæ¬„å…¬ä¼‘è¨­å®šçš„é¸å–ç‹€æ…‹
                const fp = document.getElementById('sidebar-dayoff-picker')._flatpickr;
                if(fp) {
                    fp.setDate(currentDaysOff, false); 
                }

                // æ›´æ–°å¿«é€Ÿè·³è½‰é¸å–® (ç¦ç”¨å…¬ä¼‘æ—¥æœŸ)
                const fpNav = document.getElementById('nav-date-picker')._flatpickr;
                if(fpNav) fpNav.set('disable', currentDaysOff);
                
                renderBusinessDayButtons();
            } catch (e) {}
        }
        
        async function handleDaysOffChange(selectedDates, instance) {
            const viewYear = instance.currentYear;
            const viewMonth = instance.currentMonth + 1;
            const monthStr = `${viewYear}-${String(viewMonth).padStart(2, '0')}`;
            const datesInMonth = selectedDates.map(d => formatDate(d)).filter(d => d.startsWith(monthStr));
                
            try {
                await apiCall('setDaysOff', { dates: datesInMonth, month: monthStr }, 'POST');
                await fetchDaysOff();
                const toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1000 });
                toast.fire({ icon: 'success', title: 'å…¬ä¼‘å·²æ›´æ–°' });
                
                const dateStr = formatDate(currentDate);
                if (currentDaysOff.includes(dateStr) || !currentDaysOff.includes(dateStr)) {
                     loadSchedule();
                }
            } catch(e) { console.error(e); }
        }
        
        function renderBusinessDayButtons() {
            const container = businessDaysContainer;
            container.innerHTML = '';
            
            const todayStr = formatDate(new Date());
            const viewingStr = formatDate(currentDate);

            const todayBtn = document.createElement('button');
            const isTodayActive = todayStr === viewingStr;
            todayBtn.className = `flex-shrink-0 px-4 py-2 rounded-md text-sm font-bold border transition shadow-sm ${isTodayActive ? (isCurrentDateFull ? 'btn-full-active' : 'bg-blue-600 text-white border-blue-600') : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'}`;
            todayBtn.textContent = 'ä»Šå¤©';
            todayBtn.onclick = () => { currentDate = new Date(); updateNavDatePicker(); loadSchedule(); };
            container.appendChild(todayBtn);
            
            const year = currentViewMonthDate.getFullYear();
            const month = currentViewMonthDate.getMonth(); 
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            for(let d = 1; d <= daysInMonth; d++) {
                const dateObj = new Date(year, month, d);
                const dateStr = formatDate(dateObj);
                
                if(currentDaysOff.includes(dateStr)) continue;
                
                const btn = document.createElement('button');
                const isActive = dateStr === viewingStr;
                
                const btnText = dateObj.toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric', weekday: 'short' });

                let activeClass = isActive ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white text-gray-600 border-gray-200 hover:border-blue-300 hover:text-blue-600';
                if (isActive && isCurrentDateFull) {
                    activeClass = 'btn-full-active shadow-md';
                }

                btn.className = `flex-shrink-0 px-3 py-2 flex items-center justify-center rounded-md text-sm font-medium border transition shadow-sm ${activeClass}`;
                btn.textContent = btnText;
                
                btn.onclick = () => {
                    currentDate = new Date(dateObj);
                    updateNavDatePicker(); 
                    loadSchedule();
                };
                container.appendChild(btn);
            }
        }
        
        function updateNavDatePicker() {
            const fp = document.getElementById('nav-date-picker')._flatpickr;
            if(fp) fp.setDate(currentDate, false);
        }
    </script>
</body>
</html>
